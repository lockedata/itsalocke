<!DOCTYPE html>
<html lang="en-gb">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Helping people get started with data science">
  <meta name="author" content="Locke Data">
  <meta name="generator" content="Hugo 0.25.1" />
  <title>Unit testing in SSDT – a quick intro &middot; Locke Data</title>
  <!-- Stylesheets -->
  <link href="http://lockelife.com/css/bootstrap-v3.3.7/bootstrap.min.css" rel="stylesheet">
  <link href="http://lockelife.com/css/lockedata.css" rel="stylesheet">
  <link href="http://lockelife.com/css/jquery.form-validator-v2.3.44/theme-default.min.css" rel="stylesheet">

  

  <!-- Custom Fonts -->
  <link href="http://lockelife.com/font-awesome-v4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


  
    <link rel="shortcut icon" type="image/x-icon" href="http://lockelife.com/favicon.ico">
    <link rel="icon" type="image/x-icon" href="http://lockelife.com/favicon.ico">
  


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <!--[if lt IE 9]>


  <![endif]-->
</head>


  <body id="page-top" class="single">
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">

    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
        <a class="navbar-brand page-scroll" href="/#page-top">
          
          <img src="http://lockelife.com/img/LockeDataTextNew.svg" class="img-responsive" alt="">
        </a>
      

    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li class="hidden">
          <a href="/#page-top"></a>
        </li>
        

        
          <li>
            <a href="/#casestudies">Case Studies</a>
          </li>
        
          <li>
            <a href="/#community">Community</a>
          </li>
        
          <li>
            <a href="/#calendar">Calendar</a>
          </li>
        
          <li>
            <a href="/#contact">Contact</a>
          </li>
        
          <li>
            <a href="/#company">Company</a>
          </li>
        
        
      </ul>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container-fluid -->
</nav>

    <!-- Single -->
<header>
  <div class="container">
    <div class="intro-text">
      <div class="intro-heading">Unit testing in SSDT – a quick intro</div>
      <div class="intro-lead-in"></div>
    </div>
  </div>
</header>
<section id="single">
  <div class="container">
    
      <p>This post will give you a quick run-through of adding tSQLt to an existing database project destined for Azure SQL DB. This basically covers unit testing in SSDT and there is a lot of excellent info out there, so this focuses on getting you through the initial setup as quickly as possible. This post most especially relies on the information <a href="https://agilesql.club/">Ed Elliot</a> and <a href="https://kzhendev.wordpress.com/">Ken Ross</a> have published, so do check them out for more info on this topic!</p>

<p></p>

<h2 id="before-we-get-started">Before we get started</h2>

<h3 id="prerequisites">Prerequisites</h3>

<ul>
<li>You should be comfortable with <a href="https://visualstudiomagazine.com/articles/2014/12/01/visual-studio-database-projects.aspx">database projects</a> and working with them in Visual Studio. You could do this for your first ever database project, but the learning curve might be a bit steep!</li>
<li>You need Visual Studio</li>
<li>This can work with Visual Studio 2010 and beyond. AFAIK you can&#8217;t use VS Code with database projects.</li>
<li>I&#8217;m using Visual Studio 2015 Enterprise.</li>
<li>You need the latest <a href="http://tsqlt.org/downloads/">tSQLt scripts</a>.</li>
<li>You should install the tool / extension <a href="https://visualstudiogallery.msdn.microsoft.com/435e7238-0e64-4667-8980-5b8a05dc7906">SSDT-DevPack</a> in Visual Studio.</li>
</ul>

<h3 id="sample">Sample</h3>

<p>Whilst I won&#8217;t be showing code in this, there is a companion sample database project. This is on GitHub and each key stage is shown by a branch of work. This means you can jump in at most stages and work from there. If you need some git advice, check out my quick <a href="http://stephlocke.info/Rtraining/gitin5.html">git in 5 presentation</a>.</p>

<p>The core DB is a super hero themed database.<figure id="attachment_61790" style="width: 750px" class="wp-caption aligncenter"></p>

<p><img class="wp-image-61790 size-large" src="http://res.cloudinary.com/lockedata/image/upload/h_385,w_750/v1499850236/SuperHeroERD_jdkqzc.png" alt="ER diagram for superheroes db" width="750" height="385" /><figcaption class="wp-caption-text">ER diagram for superheroes db</figcaption></figure> <figure id="attachment_61791" style="width: 750px" class="wp-caption aligncenter"><img class="wp-image-61791 size-large" src="http://res.cloudinary.com/lockedata/image/upload/h_249,w_750/v1499850235/sprocoverview_jivemk.png" alt="Database Stored Procedure overview" width="750" height="249" /><figcaption class="wp-caption-text">Database Stored Procedure overview</figcaption></figure></p>

<h2 id="create-a-database-project-or-use-an-existing-one-figure-id-attachment-61792-style-width-1014px-class-wp-caption-aligncenter">Create a database project (or use an existing one!)<figure id="attachment_61792" style="width: 1014px" class="wp-caption aligncenter"></h2>

<p><img class="wp-image-61792 size-full" src="http://res.cloudinary.com/lockedata/image/upload/v1499850234/Progress-Step1_lpizyy.png" alt="SSDT Unit Testing - core DB created" width="1014" height="379" /><figcaption class="wp-caption-text">SSDT Unit Testing &#8211; core DB created</figcaption></figure></p>

<p>This will be our database that we deploy to Azure SQL so we don&#8217;t want lots of tests gunking up our production system. We&#8217;re going to keep only the necessary code in here for our actual workloads. Plus, Azure SQL DBs (currently) can&#8217;t have CLR which tSQLt relies upon!</p>

<p>Use an existing project, or use this <a href="https://github.com/stephlocke/SSDTUnitTestingSampleRepo/tree/stubs">sample repo, branch:stubs</a> if you&#8217;d like to play along with my example.</p>

<blockquote>
<p>Make sure your database project is under source control before you start. Not only should you already be doing it but it&#8217;ll save your bacon if you do something wrong during this!</p>
</blockquote>

<h2 id="create-a-testing-database-project">Create a testing database project</h2>

<p>We now need a project for holding our tSQLt code and our unit tests. The main method I could find is &#8220;deploy tSQLt to a database, then import into a database project&#8221;. For more info on this method, or to follow it, go to &#8220;Version controlling SSDT&#8221; in <a href="https://kzhendev.wordpress.com/2014/01/08/setting-up-ssdt-database-projects-and-tsqlt/">Ken&#8217;s useful post</a>.</p>

<p>I&#8217;m lazy so I take a copy of an existing minimally-configured tSQLt database project and copy &amp; paste it into the solution&#8217;s directory. I then change the relevant folder / file names and edit the .proj file to use these new names. Once that&#8217;s done, the <em>Add Existing Project</em> option can be used to bring it into the solution. Nab a copy from the <a href="https://github.com/stephlocke/SSDTUnitTestingSampleRepo/tree/stubsandblanktestingdb">sample repo, branch:stubsandblanktestingdb</a> to have a go at this.</p>

<blockquote>
<p>C&amp;Ping a database project has the disadvantage that the tSQLt code is fixed to a given version, but at the time of writing this post, the last release was 10 months old.</p>
</blockquote>

<h2 id="configure-test-db-project-figure-id-attachment-61787-style-width-300px-class-wp-caption-alignleft">Configure test DB project<figure id="attachment_61787" style="width: 300px" class="wp-caption alignleft"></h2>

<p><img class="size-medium wp-image-61787" src="http://res.cloudinary.com/lockedata/image/upload/h_112,w_300/v1499850239/Progress-Step2_ytyen7.png" alt="SSDT Unit Testing - test DB created" width="300" height="112" /><figcaption class="wp-caption-text">SSDT Unit Testing &#8211; test DB created</figcaption></figure></p>

<p>For this system to work the test DB will need to take our core DB as part of itself so that we can write tests against the core objects, but do the testing separately. There&#8217;s a neat mechanism in database projects. To do this we <em>add a database reference</em> that puts the core DB as the <em>same database</em>.</p>

<p>We now need to get ready for doing some testing.</p>

<ul>
<li>Create a Tests folder in the test DB project.</li>
<li>Then open one of your core DB stored procedures.</li>
<li>Navigate to Tools &gt; SSDT Dev Pack &gt; Create tSQLt class in the menu</li>
<li>Select your Tests folder in the popup directory browser</li>
</ul>

<p>That yields us a Tests folder, and the unit test space for our first stored procedure. See this in action in the <a href="https://github.com/stephlocke/SSDTUnitTestingSampleRepo/tree/stubsandconfiguredtestingdb">sample repo, branch:stubsandconfiguredtestingdb</a>.</p>

<p>Repeat the opening of stored procedures and creating classes whenever you need to add unit tests for a procedure.</p>

<blockquote>
<p>You will need to build your core DB if you haven&#8217;t already so that it&#8217;s dacpac is up to date and the test DB can get all the references.</p>
</blockquote>

<h2 id="write-some-tests">Write some tests</h2>

<p>Wow, after all that setup we can now actually do some testing! With the stored procedure from the previous step still open navigate to Tools &gt; SSDT Dev Pack &gt; Create tSQLt test in the menu.</p>

<p>This gives us a similar popup to the class window we saw. We need to create a test in the stored procedure class folder that tests for something specific.</p>

<p>Ed&#8217;s SSDT-DevPack gives us a good starting point for our tests but, obviously, it&#8217;s a generic placeholder. Consult the <a href="http://tsqlt.org/user-guide/">tSQLt docs</a> for more on how to write unit tests.</p>

<p>See some unit tests in action in the <a href="https://github.com/stephlocke/SSDTUnitTestingSampleRepo/tree/stubsandfirsttests">sample repo, branch:stubsandfirsttests</a>.</p>

<blockquote>
<p>I usually unit test expected good inputs, edge cases in business logic, expected bad inputs, past bugs / issues</p>
</blockquote>

<h2 id="run-our-tests-figure-id-attachment-61788-style-width-300px-class-wp-caption-alignleft">Run our tests<figure id="attachment_61788" style="width: 300px" class="wp-caption alignleft"></h2>

<p><img class="size-medium wp-image-61788" src="http://res.cloudinary.com/lockedata/image/upload/h_112,w_300/v1499850238/Progress-Step3_behr1w.png" alt="SSDT Unit Testing - database unit tests run" width="300" height="112" /><figcaption class="wp-caption-text">SSDT Unit Testing &#8211; database unit tests run</figcaption></figure></p>

<p>To run our tests, we&#8217;re going to publish to <a href="http://blog.chudinov.net/using-localdb-in-development/">LocalDB</a>. By publishing to the LocalDB, the PostDeploy script gets kicked off and runs all the tests. The database publish will fail if any of the tests fail. Rinse and repeat until your code passes all your unit tests!</p>

<p>Use the deployment profile in <a href="https://github.com/stephlocke/SSDTUnitTestingSampleRepo/tree/stubsanddeployprofile">sample repo, branch:stubsanddeployprofile</a> to do a sample deployment into LocalDB.</p>

<blockquote>
<p>In my actual Azure SQL DB, I&#8217;ve got things like containerised users that aren&#8217;t compatible with LocalDB but thankfully, amending some of the deploy settings easily solves this. Ignore anything like users, credentials, and permissions in Publish &#8230; &gt; Advanced &#8230; for the test DB deployment to LocalDB.</p>
</blockquote>

<h2 id="publish-for-realsies-figure-id-attachment-61789-style-width-300px-class-wp-caption-alignleft">Publish for realsies<figure id="attachment_61789" style="width: 300px" class="wp-caption alignleft"></h2>

<p><img class="size-medium wp-image-61789" src="http://res.cloudinary.com/lockedata/image/upload/h_112,w_300/v1499850237/Progress-Step4_bh79az.png" alt="SSDT Unit Testing - core DB deployed to production" width="300" height="112" /><figcaption class="wp-caption-text">SSDT Unit Testing &#8211; core DB deployed to production</figcaption></figure></p>

<p>Once you&#8217;ve gotten your code to pass your unit tests, you can then safely deploy your core DB to dev / UAT / production etc. You can also extend this to do continuous integration and deployment if you wanted, instead of manual deployments.</p>

<p><em>C&#8217;est fini!</em></p>

<h2 id="extending-things">Extending things</h2>

<p>This sample project used only takes you as far as writing unit tests for stub procedures &#8211; one&#8217;s that don&#8217;t actually do anything but return the inputs. This, of course, means they don&#8217;t serve any purpose. Check out the <a href="https://github.com/stephlocke/SSDTUnitTestingSampleRepo/tree/master">master branch</a> as I develop it more and fold further features in it.</p>
    
  </div>
</section>


    
    

    

    

    <!-- jQuery -->
<script src='js/jquery-v3.2.1/jquery.min.js'></script>

<!-- Bootstrap Core -->
<script src="http://lockelife.com/js/bootstrap-v3.3.7/bootstrap.min.js"></script>



<!-- Custom Theme -->
<script src="http://lockelife.com/js/agency.js"></script>






  
 <!-- calendar -->
 <script src='js/moment-v2.18.1/moment.min.js'></script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.js"></script>
  <link href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.css" rel="stylesheet" type="text/css">
  <link href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.print.css" rel="stylesheet" type="text/css" media='print'>
<script src='js/moment-v2.18.1/moment.min.js'></script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/gcal.min.js"></script>
  <link href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.css" rel="stylesheet" type="text/css">
  <link href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.print.css" rel="stylesheet" type="text/css" media='print'>
<script>

	$(document).ready(function() {
	
		$('#calendarobj').fullCalendar({

			header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month,listYear'
			},

			displayEventTime: false, 

        googleCalendarApiKey: 'AIzaSyATQH8hB-JTno5Snw11GZ4uZVNVxbaiIIc',
        events: {
            googleCalendarId: 'n58bvqjr8a5ur8jgb2o712mn4k@group.calendar.google.com'
        },
			editable: false,
			eventClick: function(event) {
				
				window.open(event.url, 'gcalevent', 'width=700,height=600');
				return false;
			},
			
			loading: function(bool) {
				$('#loading').toggle(bool);
			}
			
		});
		
	});

</script>


  </body>
</html>
