<!DOCTYPE html>
<html lang="en-gb">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Helping people get started with data science">
  <meta name="author" content="Locke Data">
  <meta name="generator" content="Hugo 0.25.1" />
  <title>Working with Azure Blob Storage, some notes &middot; Locke Data</title>
  <!-- Stylesheets -->
  <link href="http://lockelife.com/css/bootstrap-v3.3.7/bootstrap.min.css" rel="stylesheet">
  <link href="http://lockelife.com/css/lockedata.css" rel="stylesheet">
  <link href="http://lockelife.com/css/jquery.form-validator-v2.3.44/theme-default.min.css" rel="stylesheet">

  

  <!-- Custom Fonts -->
  <link href="http://lockelife.com/font-awesome-v4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


  
    <link rel="shortcut icon" type="image/x-icon" href="http://lockelife.com/favicon.ico">
    <link rel="icon" type="image/x-icon" href="http://lockelife.com/favicon.ico">
  


  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <!--[if lt IE 9]>


  <![endif]-->
</head>


  <body id="page-top" class="single">
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container">

    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
        <a class="navbar-brand page-scroll" href="/#page-top">
          
          <img src="http://lockelife.com/img/LockeDataTextNew.svg" class="img-responsive" alt="">
        </a>
      

    </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        <li class="hidden">
          <a href="/#page-top"></a>
        </li>
        

        
          <li>
            <a href="/#casestudies">Case Studies</a>
          </li>
        
          <li>
            <a href="/#community">Community</a>
          </li>
        
          <li>
            <a href="/#calendar">Calendar</a>
          </li>
        
          <li>
            <a href="/#contact">Contact</a>
          </li>
        
          <li>
            <a href="/#company">Company</a>
          </li>
        
        
      </ul>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container-fluid -->
</nav>

    <!-- Single -->
<header>
  <div class="container">
    <div class="intro-text">
      <div class="intro-heading">Working with Azure Blob Storage, some notes</div>
      <div class="intro-lead-in"></div>
    </div>
  </div>
</header>
<section id="single">
  <div class="container">
    
      <p>I&#8217;m working on building a snazzy <a href="https://github.com/stephlocke/Rtraining/blob/master/inst/slidedecks/shiny/Dashboards.Rmd" title="My shiny presentation" target="_blank">shiny</a> app that a) drops the inputs/parameter values into <a href="http://azure.microsoft.com/en-gb/documentation/articles/storage-introduction/" title="Azure storage intro" target="_blank">blob storage</a> and b) uses <a href="http://azure.microsoft.com/en-gb/services/stream-analytics/" title="Stream Analytics" target="_blank">Stream Analytics</a> to query the values and present back what people are saying at the moment. This&#8217;ll be a fab tool for <a href="https://itsalocke.com/index.php/r-pre-con-sqlsat-exeter/" title="My R Pre-Con: SQLSat Exeter" target="_blank">my pre-con next month</a> if I can get it working in time!</p>

<p>Getting it working, does however mean utilising the <a href="https://msdn.microsoft.com/en-us/library/azure/dd179355.aspx" title="Storage API documentation" target="_blank">Azure Blob Storage API</a> in R which I confess is much harder than expected, especially after the ease of using the Visual Studio Online API for <a href="https://itsalocke.com/index.php/bride-of-frankenstein-tfs-r/" title="Bride of Frankenstein: TFS + R" target="_blank">tfsR</a>. To that end, I thought I&#8217;d write-up some of my findings before I do a bigger write-up that illustrates how to do everything (in R).</p>

<p>I&#8217;m working my way through an <a href="http://justazure.com/azure-blob-storage-part-one-introduction/" title="Just Azure - working with blob storage">intro to azure storage</a> on the (hopefully reasonable) expectation that more knowledge will make it easier to work with. There&#8217;s additionally the <a href="https://msdn.microsoft.com/en-us/library/azure/dd135733.aspx" title="Blob Storage REST API" target="_blank">online reference</a>, although I found the <a href="https://www.visualstudio.com/en-us/integrate/api/overview" title="Visual Studio Online REST API documentation" target="_blank">VSO REST API</a> documentation easier to understand and get started with.</p>

<p></p>

<h2 id="necessary-info">Necessary info</h2>

<p>To connect to an Azure Blob storage container you need to know your account name, access key, and container that you want to interact with.</p>

<ul>
<li>account name will be the blob storage account name</li>
<li>the access key is either the primary or secondary access keys (either one is fine) and it&#8217;s worth noting that this is encoded in base64 already, so you may need to decode it before you can use it</li>
<li>the container name you want to put blobs in</li>
</ul>

<h2 id="constructing-a-signature">Constructing a signature</h2>

<p>It&#8217;s a bit weird (in my eyes anyway) but to <a href="https://msdn.microsoft.com/en-us/library/azure/dd179428.aspx" title="Azure Storage Authentication" target="_blank">authenticate your request</a> to use blob storage you have to send the request basically twice &#8211; once as the main request, and second as an identical but encoded signature in the headers of the main request.</p>

<p>When you&#8217;re constructing your request you need to:</p>

<ul>
<li><p>Fix a date value to be used twice within the signature. This has to be a specific format and in R I create it via:</p>

<p><code>x-ms-date &lt;- format(Sys.time(),&quot;%a, %d %b %Y %H:%M:%S %Z&quot;, tz=&quot;GMT&quot;)</code></p></li>

<li><p>Construct a &#8220;Canonicalized Header&#8221; containing the x-ms-date and x-ms-version, separated with line breaks, in the format <code>headertitle:headervalue</code></p></li>

<li><p>Similarly, build a &#8220;Canonicalized Resource&#8221; holding <code>/accountname/container</code> and all query parameters that appear in your API call, i.e. everything after the ?. These parameters needs to be in alphabetical order and separated with line breaks, in the format <code>headertitle:headervalue</code></p></li>

<li><p>Construct a string of:</p>

<ul>
<li>the API call verb</li>
<li>12 carriage returns</li>
<li>the &#8220;Canonicalized Header&#8221;</li>
<li>the &#8220;Canonicalized Resource&#8221;</li>
</ul></li>
</ul>

<h2 id="encoding-the-signature">Encoding the signature</h2>

<p>Using the (un-encoded) access key as the key or basis for this next bit you have to:</p>

<ul>
<li>Make sure your signature string is UTF8 encoded</li>
<li>Encrypt this using HMAC using the SHA-256 algorithm</li>
<li>Encode this into base64</li>
</ul>

<h2 id="sending-the-signature">Sending the signature</h2>

<p>Phew! After all that work, the encoded signature string (as the Authorization header), the x-ms-date and x-ms-version all need to be sent in the header of the request.</p>

<h2 id="my-next-steps">My next steps</h2>

<p>I have <a href="https://github.com/stephlocke/Rtraining/tree/253b1584c045125ad2be89f65cbf45cc62133452/R" title="Rtraining Azure Blob Storage functions" target="_blank">work in progress R functions for this task in my Rtraining package</a>, I&#8217;m currently working on the sending of JSON to the BLOB storage and verifying how this needs to be handled in my signature string.</p>

<p><strong>If you see any inaccuracies, misunderstandings, potential improvements, or rational explanations for the stuff above, please let me know by commenting!</strong></p>
    
  </div>
</section>


    
    

    

    

    <!-- jQuery -->
<script src='js/jquery-v3.2.1/jquery.min.js'></script>

<!-- Bootstrap Core -->
<script src="http://lockelife.com/js/bootstrap-v3.3.7/bootstrap.min.js"></script>



<!-- Custom Theme -->
<script src="http://lockelife.com/js/agency.js"></script>






  
 <!-- calendar -->
 <script src='js/moment-v2.18.1/moment.min.js'></script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.js"></script>
  <link href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.css" rel="stylesheet" type="text/css">
  <link href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.print.css" rel="stylesheet" type="text/css" media='print'>
<script src='js/moment-v2.18.1/moment.min.js'></script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/gcal.min.js"></script>
  <link href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.css" rel="stylesheet" type="text/css">
  <link href="//cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.print.css" rel="stylesheet" type="text/css" media='print'>
<script>

	$(document).ready(function() {
	
		$('#calendarobj').fullCalendar({

			header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month,listYear'
			},

			displayEventTime: false, 

        googleCalendarApiKey: 'AIzaSyATQH8hB-JTno5Snw11GZ4uZVNVxbaiIIc',
        events: {
            googleCalendarId: 'n58bvqjr8a5ur8jgb2o712mn4k@group.calendar.google.com'
        },
			editable: false,
			eventClick: function(event) {
				
				window.open(event.url, 'gcalevent', 'width=700,height=600');
				return false;
			},
			
			loading: function(bool) {
				$('#loading').toggle(bool);
			}
			
		});
		
	});

</script>


  </body>
</html>
